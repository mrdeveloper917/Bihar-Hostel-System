<% title = "Student Dashboard" %>

<section class="dashboard container-fluid py-5 px-md-4">
  <!-- ðŸŒ… HEADER -->
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5 animate__animated animate__fadeInDown"
  >
    <div>
      <h2 class="fw-bold mb-2 text-gradient">
        ðŸ‘‹ Welcome, <%= user.name || 'Student' %>
      </h2>
      <p class="text-muted fs-6 mb-0">
        Hereâ€™s your personalized hostel overview â€” rooms, fees, notices, and
        more.
      </p>
    </div>
    <div class="date-badge mt-3 mt-md-0">
      <i class="bi bi-calendar3 me-2"></i>
      <span>Today: <%= new Date().toLocaleDateString() %></span>
    </div>
  </div>

  <!-- ðŸŒˆ QUICK STATS -->
  <div class="row g-4 mb-5">
    <% const cards = [
      { icon: "wallet2", title: "Total Fees Paid", value: `â‚¹${student.totalFeesPaid || 0}`, color: "primary" },
      { icon: "building", title: "Room", value: student.roomNumber || "N/A", color: "success" },
      { icon: "exclamation-circle", title: "Pending Complaints", value: complaintsPending || 0, color: "warning" },
      { icon: "calendar-check", title: "Leaves Approved", value: approvedLeaves || 0, color: "info" }
    ]; %>
    <% cards.forEach(c => { %>
      <div class="col-md-3 col-6">
        <div class="summary-card bg-gradient-<%= c.color %> text-white shadow-lg hover-glow">
          <i class="bi bi-<%= c.icon %> fs-3 mb-3"></i>
          <h6 class="fw-semibold mb-1"><%= c.title %></h6>
          <h3 class="fw-bold mb-0"><%= c.value %></h3>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- âš¡ DASHBOARD SECTIONS -->
  <div class="row g-4">
    <!-- ðŸ  ROOM DETAILS -->
    <div class="col-lg-4">
      <div class="card dashboard-card glass-card p-4 border-0 shadow-sm hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div class="icon-circle bg-gradient-primary me-3">
            <i class="bi bi-house-door fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Room Details</h5>
        </div>
        <p class="text-secondary mb-1">
          Room No: <strong><%= student.roomNumber || 'N/A' %></strong>
        </p>
        <p class="text-secondary mb-3">
          Hostel: <strong><%= student.hostelName || 'N/A' %></strong>
        </p>
        <a href="/student/rooms" class="btn btn-outline-primary btn-sm rounded-pill px-4">View Details</a>
      </div>
    </div>

    <!-- ðŸ’¸ FEES DETAILS -->
    <div class="col-lg-4">
      <div class="card dashboard-card glass-card p-4 border-0 shadow-sm hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div class="icon-circle bg-gradient-success me-3">
            <i class="bi bi-cash-coin fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Fee Status</h5>
        </div>
        <% const feeProgress = student.feeStatus === 'Paid' ? 100 : student.feeStatus === 'Partial' ? 60 : 20; %>
        <p class="text-secondary mb-2">Status: <strong><%= student.feeStatus || 'Not set' %></strong></p>
        <div class="progress mb-3" style="height: 8px">
          <div class="progress-bar bg-success progress-animate" style=`width: <%= feeProgress %>%`></div>
        </div>
        <canvas id="feeChart" height="130"></canvas>
        <a href="/student/fees" class="btn btn-success btn-sm rounded-pill px-4 mt-3">Pay / View</a>
      </div>
    </div>

    <!-- ðŸ“£ HOSTEL NOTICES -->
    <div class="col-lg-4">
      <div class="card dashboard-card glass-card p-4 border-0 shadow-sm hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div class="icon-circle bg-gradient-warning me-3">
            <i class="bi bi-megaphone fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Latest Notices</h5>
        </div>
        <ul class="list-group list-group-flush small">
          <% if (notices && notices.length > 0) { %>
            <% notices.slice(0, 3).forEach(n => { %>
              <li class="list-group-item bg-transparent border-0 ps-0">
                ðŸ“Œ <%= n.title %><br />
                <small class="text-muted"><%= n.date %></small>
              </li>
            <% }) %>
          <% } else { %>
            <li class="text-muted text-center py-3">No new notices.</li>
          <% } %>
        </ul>
        <a href="/student/notices" class="btn btn-warning btn-sm rounded-pill text-dark mt-3">View All</a>
      </div>
    </div>
  </div>

  <!-- ðŸ§­ SECOND ROW -->
  <div class="row g-4 mt-4">
    <!-- ðŸšª LEAVE REQUEST -->
    <div class="col-lg-6">
      <div class="card dashboard-card glass-card p-4 shadow-sm border-0 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div class="icon-circle bg-gradient-info me-3">
            <i class="bi bi-person-walking fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Leave Requests</h5>
        </div>
        <p class="text-muted small mb-3">
          Track your submitted and approved leave requests.
        </p>
        <a href="/student/leaves" class="btn btn-info text-white btn-sm rounded-pill px-4">Manage Leaves</a>
      </div>
    </div>

    <!-- ðŸŒ¤ WEATHER WIDGET -->
    <div class="col-lg-6">
      <div class="card dashboard-card glass-card p-4 border-0 shadow-sm hover-lift text-center">
        <div class="d-flex justify-content-center align-items-center mb-3">
          <div class="icon-circle bg-gradient-primary me-3">
            <i class="bi bi-cloud-sun fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Weather in Bihar</h5>
        </div>
        <div id="weather-widget" class="text-center text-muted small">
          Loading weather...
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ§¹ MAINTENANCE REQUESTS -->
  <div class="row g-4 mt-4">
    <div class="col-lg-6">
      <div class="card dashboard-card glass-card p-4 shadow-sm border-0 hover-lift">
        <div class="d-flex align-items-center mb-3">
          <div class="icon-circle bg-gradient-info me-3">
            <i class="bi bi-tools fs-4 text-white"></i>
          </div>
          <h5 class="fw-semibold mb-0">Maintenance Requests</h5>
        </div>
        <p class="text-muted small mb-3">
          Submit or track your maintenance issues like fan, lights, etc.
        </p>
        <ul class="list-group list-group-flush small mb-3">
          <% if (typeof maintenance !== "undefined" && maintenance.length > 0) { %>
            <% maintenance.slice(0, 3).forEach(m => { %>
              <li class="list-group-item bg-transparent border-0 d-flex justify-content-between">
                <span><%= m.issue %> â€” <%= m.room %></span>
                <span class="badge bg-<%= m.status === 'Resolved' ? 'success' : m.status === 'In Progress' ? 'warning text-dark' : 'secondary' %>">
                  <%= m.status %>
                </span>
              </li>
            <% }) %>
          <% } else { %>
            <li class="list-group-item bg-transparent border-0 text-center text-muted">No maintenance requests yet.</li>
          <% } %>
        </ul>
        <a href="/student/maintenance" class="btn btn-info text-white btn-sm rounded-pill px-4">Request Maintenance</a>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById("feeChart");
  if (ctx) {
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Paid", "Pending"],
        datasets: [{
          data: ["<%= student.totalFeesPaid || 0 %>", 100 - "<%= student.totalFeesPaid || 0 %>"],
          backgroundColor: ["#28a745", "#ffc107"],
          borderWidth: 3
        }]
      },
      options: {
        cutout: "70%",
        plugins: { legend: { display: false } }
      }
    });
  }

  fetch("https://wttr.in/Patna?format=%C+%t")
    .then(res => res.text())
    .then(data => document.getElementById("weather-widget").innerText = data)
    .catch(() => document.getElementById("weather-widget").innerText = "Unable to fetch weather");
</script>

<style>
  body {
    background: radial-gradient(circle at top left, #eef2ff, #f9fbff);
    font-family: "Poppins", sans-serif;
  }
  .text-gradient {
    background: linear-gradient(90deg, #007bff, #6610f2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .summary-card { border-radius: 20px; text-align: center; padding: 25px 15px; transition: all 0.4s ease; }
  .summary-card:hover { transform: translateY(-6px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
  .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; transition: 0.4s ease; }
  .hover-lift:hover { transform: translateY(-6px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
  .icon-circle { width: 58px; height: 58px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .bg-gradient-primary { background: linear-gradient(135deg, #007bff, #00bfff); }
  .bg-gradient-success { background: linear-gradient(135deg, #28a745, #20c997); }
  .bg-gradient-warning { background: linear-gradient(135deg, #ffc107, #ff8c00); }
  .bg-gradient-info { background: linear-gradient(135deg, #17a2b8, #00c3ff); }
  .date-badge { background: rgba(255, 255, 255, 0.7); border-radius: 30px; padding: 8px 16px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); backdrop-filter: blur(6px); }
  .progress { background: #eaeaea; border-radius: 20px; overflow: hidden; }
  .progress-animate { transition: width 1.2s ease; }
  @media (max-width: 768px) {
    .summary-card { padding: 15px 10px; }
    .dashboard-card { text-align: center; }
    .icon-circle { margin: 0 auto 10px; }
  }
</style>
