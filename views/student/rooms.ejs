<% title = "Available Rooms" %>

<section class="available-rooms container-fluid py-5 px-md-5">
  <!-- HEADER -->
  <div class="header-section text-center mb-5">
    <h2 class="fw-bold text-gradient mb-2">
      <i class="bi bi-door-open me-2"></i> Available Rooms
    </h2>
    <p class="text-muted mb-0">
      Find the perfect room that suits your comfort.
    </p>
  </div>

  <!-- FILTERS -->
  <div
    class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2"
  >
    <div class="d-flex gap-2 flex-wrap">
      <input
        type="text"
        id="searchRoom"
        class="form-control shadow-sm rounded-pill"
        placeholder="ðŸ” Search by room number..."
        style="max-width: 280px"
      />
      <select
        id="statusFilter"
        class="form-select shadow-sm rounded-pill"
        style="max-width: 180px"
      >
        <option value="all">All</option>
        <option value="vacant">Vacant</option>
        <option value="occupied">Occupied</option>
      </select>
    </div>
    <div class="date-pill shadow-sm">
      <i class="bi bi-calendar-event me-2"></i> Updated: <%= new
      Date().toLocaleDateString() %>
    </div>
  </div>

  <% if (rooms && rooms.length > 0) { %>
  <div class="row g-4" id="roomGrid">
    <% rooms.forEach(room => { %>
    <div
      class="col-sm-6 col-md-4 col-lg-3 room-card-wrapper"
      data-room="<%- JSON.stringify(room) %>"
      data-status="<%= room.isOccupied ? 'occupied' : 'vacant' %>"
      data-number="<%= room.roomNumber %>"
    >
      <div
        class="card border-0 shadow-lg rounded-5 glass-card h-100 hover-up room-card"
        role="button"
      >
        <div class="card-body text-center">
          <div class="room-icon mb-3">
            <i class="bi bi-door-closed fs-1 text-primary"></i>
          </div>
          <h5 class="fw-bold">Room <%= room.roomNumber %></h5>
          <p class="small text-muted mb-1">
            <i class="bi bi-building me-1"></i> Type: <%= room.type ||
            'Standard' %>
          </p>
          <p class="small text-muted mb-3">
            <i class="bi bi-people me-1"></i> Capacity: <%= room.capacity || 2
            %> beds
          </p>
          <span
            class="badge px-3 py-2 rounded-pill shadow-sm <%= room.isOccupied ? 'bg-gradient-danger' : 'bg-gradient-success' %>"
          >
            <%= room.isOccupied ? 'Occupied' : 'Vacant' %>
          </span>
          <div class="mt-4">
            <% if (!room.isOccupied) { %>
            <button
              class="btn btn-gradient rounded-pill px-4 shadow-sm btn-book"
              data-room-number="<%= room.roomNumber %>"
            >
              <i class="bi bi-calendar-plus me-1"></i> Book Now
            </button>
            <% } else { %>
            <button
              class="btn btn-outline-secondary rounded-pill px-4"
              disabled
            >
              <i class="bi bi-lock me-1"></i> Not Available
            </button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
  <% } else { %>
  <div class="text-center py-5 empty-state">
    <img
      src="https://cdn-icons-png.flaticon.com/512/4076/4076505.png"
      width="90"
      class="mb-3 opacity-75"
      alt="No data"
    />
    <h5 class="fw-semibold mb-1">No rooms available</h5>
    <p class="text-muted small">Please check back later.</p>
  </div>
  <% } %>
</section>

<!-- ðŸ  ROOM DETAILS MODAL -->
<div class="modal fade" id="roomDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content glass-modal border-0 rounded-5 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold text-primary">
          <i class="bi bi-door-closed me-2"></i> Room Details
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="row g-4 align-items-center">
          <div class="col-md-4 text-center">
            <i class="bi bi-house-door display-4 text-gradient mb-3"></i>
            <h4 class="fw-bold" id="modalRoomNumber"></h4>
            <span id="modalStatusBadge"></span>
          </div>
          <div class="col-md-8">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <strong>Type:</strong> <span id="modalType"></span>
              </li>
              <li class="list-group-item">
                <strong>Capacity:</strong> <span id="modalCapacity"></span>
              </li>
              <li class="list-group-item">
                <strong>Floor:</strong> <span id="modalFloor"></span>
              </li>
              <li class="list-group-item">
                <strong>Amenities:</strong> <span id="modalAmenities"></span>
              </li>
              <li class="list-group-item">
                <strong>Occupant:</strong> <span id="modalOccupant"></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 justify-content-between">
        <button
          type="button"
          class="btn btn-outline-secondary rounded-pill"
          data-bs-dismiss="modal"
        >
          Close
        </button>
        <button id="bookNowBtn" class="btn btn-gradient rounded-pill px-4">
          <i class="bi bi-calendar2-plus me-1"></i> Book This Room
        </button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastMessage" class="toast text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-exclamation-triangle me-2"></i> Room not available!
      </div>
      <button
        type="button"
        class="btn-close btn-close-white me-2 m-auto"
        data-bs-dismiss="toast"
      ></button>
    </div>
  </div>
</div>

<!-- âœ… Bootstrap JS Bundle -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>

<!-- ====== SCRIPTS ====== -->
<script>
  const searchInput = document.getElementById("searchRoom");
  const statusSelect = document.getElementById("statusFilter");
  const roomCards = document.querySelectorAll(".room-card-wrapper");
  const modalEl = document.getElementById("roomDetailsModal");
  const modal = new bootstrap.Modal(modalEl);
  const toast = new bootstrap.Toast(document.getElementById("toastMessage"));

  let selectedRoom = null;

  // Search & Filter
  function filterRooms() {
    const query = searchInput.value.toLowerCase();
    const status = statusSelect.value;
    roomCards.forEach((card) => {
      const number = card.dataset.number.toLowerCase();
      const matchesNumber = number.includes(query);
      const matchesStatus = status === "all" || card.dataset.status === status;
      card.style.display = matchesNumber && matchesStatus ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filterRooms);
  statusSelect.addEventListener("change", filterRooms);

  // Room Details Modal
  document.querySelectorAll(".room-card").forEach((card) => {
    card.addEventListener("click", () => {
      const data = JSON.parse(card.closest(".room-card-wrapper").dataset.room);
      selectedRoom = data;

      document.getElementById("modalRoomNumber").textContent =
        "Room " + data.roomNumber;
      document.getElementById("modalType").textContent =
        data.type || "Standard";
      document.getElementById("modalCapacity").textContent = data.capacity || 2;
      document.getElementById("modalFloor").textContent =
        data.floor || "Ground";
      document.getElementById("modalAmenities").textContent = data.amenities
        ? data.amenities.join(", ")
        : "Bed, Fan, Light";
      document.getElementById("modalOccupant").textContent = data.isOccupied
        ? data.occupantName || "Occupied by another student"
        : "Vacant";
      document.getElementById("modalStatusBadge").innerHTML = data.isOccupied
        ? '<span class="badge bg-gradient-danger px-3 py-2">Occupied</span>'
        : '<span class="badge bg-gradient-success px-3 py-2">Vacant</span>';

      modal.show();
    });
  });

  // Book Room from Card Buttons
  document.querySelectorAll(".btn-book").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const roomNumber = btn.dataset.roomNumber;
      window.location.href = `/student/bookings?room=${roomNumber}`;
    });
  });

  // Book Room from Modal
  document.getElementById("bookNowBtn").addEventListener("click", () => {
    if (!selectedRoom) return;
    if (selectedRoom.isOccupied) {
      toast.show();
      return;
    }
    window.location.href = `/student/bookings?room=${selectedRoom.roomNumber}`;
  });
</script>

<!-- ====== STYLES ====== -->
<style>
  .text-gradient {
    background: linear-gradient(90deg, #007bff, #6610f2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .btn-gradient {
    background: linear-gradient(135deg, #007bff, #6610f2);
    color: #fff;
    border: none;
    transition: 0.3s ease;
  }

  .btn-gradient:hover {
    background: linear-gradient(135deg, #6610f2, #007bff);
    transform: scale(1.05);
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(12px);
    transition: all 0.3s ease;
  }

  .hover-up:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  }

  .glass-modal {
    background: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(14px);
    animation: slideUp 0.4s ease;
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .bg-gradient-success {
    background: linear-gradient(135deg, #28a745, #20c997);
  }

  .bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545, #ff5c75);
  }

  .date-pill {
    background: #f8f9fa;
    padding: 8px 14px;
    border-radius: 25px;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .toast {
    opacity: 0.95;
  }

  .list-group-item {
    border: none;
    background: transparent;
  }
</style>
