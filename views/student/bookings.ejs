<% title = "My Bookings" %>

<section class="py-5 px-3 px-md-5">
  <div class="container-fluid">
    <!-- HEADER -->
    <div
      class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4"
    >
      <div>
        <h2 class="fw-bold text-gradient mb-1">
          <i class="bi bi-calendar-check me-2"></i> My Bookings
        </h2>
        <p class="text-muted mb-0">
          Manage your hostel room bookings easily and track their approval
          status.
        </p>
      </div>
      <div class="d-flex gap-2 mt-3 mt-md-0 align-items-center">
        <button
          class="btn btn-gradient shadow-sm rounded-pill px-3"
          data-bs-toggle="modal"
          data-bs-target="#bookRoomModal"
        >
          <i class="bi bi-plus-circle me-2"></i> Book New Room
        </button>
        <div class="date-pill shadow-sm">
          <i class="bi bi-clock me-2"></i>
          Updated: <%= new Date().toLocaleDateString() %>
        </div>
      </div>
    </div>

    <!-- BOOKINGS TABLE -->
    <div class="card shadow-lg border-0 rounded-4 glass-card">
      <div class="card-body p-0">
        <% if (bookings && bookings.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 text-center">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Room</th>
                <th>Status</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="bookingTableBody">
              <% bookings.forEach((b, idx) => { %>
              <tr id="booking-<%= b._id %>">
                <td class="fw-semibold"><%= idx + 1 %></td>
                <td>
                  <i class="bi bi-door-closed me-2 text-primary"></i> Room <%=
                  b.roomNumber %>
                </td>
                <td>
                  <span
                    class="badge px-3 py-2 rounded-pill shadow-sm text-uppercase <%= b.status === 'approved' ? 'bg-gradient-success' : b.status === 'pending' ? 'bg-gradient-warning text-dark' : 'bg-gradient-danger' %>"
                  >
                    <i
                      class="bi <%= b.status === 'approved' ? 'bi-check-circle' : b.status === 'pending' ? 'bi-hourglass-split' : 'bi-x-circle' %> me-1"
                    ></i>
                    <%= b.status %>
                  </span>
                </td>
                <td class="text-muted">
                  <%= new Date(b.createdAt).toLocaleDateString() %>
                </td>
                <td>
                  <% if (b.status === 'pending') { %>
                  <button
                    class="btn btn-sm btn-outline-danger rounded-pill cancel-btn"
                    data-id="<%= b._id %>"
                  >
                    <i class="bi bi-x-circle me-1"></i> Cancel
                  </button>
                  <% } else { %>
                  <span class="text-muted small">â€”</span>
                  <% } %>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-info-circle fs-2 d-block mb-3"></i>
          <h6 class="fw-semibold">No bookings found.</h6>
          <p class="small">You havenâ€™t made any room bookings yet.</p>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- ðŸ  Book New Room Modal -->
  <div class="modal fade" id="bookRoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 rounded-4 shadow-lg">
        <div class="modal-header bg-gradient-primary text-white">
          <h5 class="modal-title fw-semibold">
            <i class="bi bi-house-add me-2"></i>Book a Room
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <form id="bookRoomForm">
            <div class="mb-3">
              <label class="form-label fw-semibold">Select a Room</label>
              <select class="form-select rounded-pill" id="roomSelect" required>
                <option value="">-- Choose a vacant room --</option>
                <% vacantRoomsList.forEach(room => { %>
                <option value="<%= room.roomNumber %>">
                  Room <%= room.roomNumber %> - <%= room.type %>
                </option>
                <% }) %>
              </select>
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-gradient rounded-pill px-4">
                <i class="bi bi-check2-circle me-1"></i> Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Toast Notification -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div
      id="successToast"
      class="toast text-white bg-success border-0 shadow-lg"
      role="alert"
    >
      <div class="d-flex align-items-center">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>Booking created successfully!
        </div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
        ></button>
      </div>
    </div>

    <div
      id="errorToast"
      class="toast text-white bg-danger border-0 shadow-lg"
      role="alert"
    >
      <div class="d-flex align-items-center">
        <div class="toast-body">
          <i class="bi bi-x-circle me-2"></i>Something went wrong!
        </div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
        ></button>
      </div>
    </div>
  </div>
</section>

<!-- âœ… Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Cancel booking
  document.querySelectorAll(".cancel-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (!confirm("Cancel this booking?")) return;
      btn.disabled = true;
      btn.innerHTML = "Cancelling...";
      try {
        const res = await fetch(`/student/bookings/${id}/cancel`, {
          method: "POST",
        });
        if (res.ok) {
          const row = btn.closest("tr");
          const badge = row.querySelector(".badge");
          badge.className =
            "badge bg-gradient-danger text-white px-3 py-2 rounded-pill shadow-sm";
          badge.innerHTML = '<i class="bi bi-x-circle me-1"></i> Canceled';
          btn.remove();
          new bootstrap.Toast(document.getElementById("successToast")).show();
        } else throw new Error();
      } catch (err) {
        new bootstrap.Toast(document.getElementById("errorToast")).show();
      }
    });
  });

  // Create new booking
  document
    .getElementById("bookRoomForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const roomNumber = document.getElementById("roomSelect").value;
      if (!roomNumber) return alert("Please select a room!");

      const btn = e.target.querySelector("button[type='submit']");
      btn.disabled = true;
      btn.innerHTML = "Submitting...";

      try {
        const res = await fetch("/student/bookings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roomNumber }),
        });
        if (res.ok) {
          new bootstrap.Toast(document.getElementById("successToast")).show();
          setTimeout(() => location.reload(), 1000);
        } else {
          new bootstrap.Toast(document.getElementById("errorToast")).show();
        }
      } catch (err) {
        new bootstrap.Toast(document.getElementById("errorToast")).show();
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Submit';
      }
    });
</script>

<!-- âœ… Styles -->
<style>
  body {
    background: #f5f7fa;
  }
  .text-gradient {
    background: linear-gradient(90deg, #007bff, #6610f2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .btn-gradient {
    background: linear-gradient(135deg, #007bff, #00bfff);
    color: #fff;
    border: none;
    transition: all 0.3s ease;
  }
  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  .date-pill {
    background: #f1f3f5;
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 500;
    font-size: 0.9rem;
  }
  .bg-gradient-success {
    background: linear-gradient(135deg, #28a745, #20c997);
  }
  .bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107, #ff8c00);
  }
  .bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545, #ff5c75);
  }
  .table {
    font-size: 0.95rem;
  }
  .badge {
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
  }
  .modal-content {
    border-radius: 20px;
    overflow: hidden;
  }
  .toast {
    border-radius: 15px;
    opacity: 0.95;
  }
</style>
