<% title = "My Visitors" %>

<section class="container py-5 animate__animated animate__fadeIn">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
    <div>
      <h2 class="fw-bold text-gradient mb-1">ðŸ‘¥ My Visitor Log</h2>
      <p class="text-muted small mb-0">
        Add visitor requests, check approval status & view recent history.
      </p>
    </div>

    <button
      class="btn btn-gradient rounded-pill shadow-sm px-4"
      onclick="document.getElementById('addVisitorForm').scrollIntoView({ behavior: 'smooth' })"
    >
      <i class="bi bi-person-plus me-1"></i> Add Visitor
    </button>
  </div>

  <!-- Add Visitor Form -->
  <div id="addVisitorForm" class="glass-card shadow-sm rounded-4 p-4 mb-5">
    <h5 class="fw-semibold mb-3 text-primary">
      <i class="bi bi-person-plus me-2"></i>Add New Visitor Request
    </h5>

    <!-- FORM: uses simple date + time inputs. JS combines them into hidden inTime/outTime ISO fields -->
    <form
      id="visitorForm"
      action="/student/visitors/add"
      method="POST"
      class="row g-3"
    >
      <div class="col-md-4">
        <label class="form-label fw-semibold">Visitor Name</label>
        <input
          type="text"
          name="name"
          class="form-control rounded-pill"
          placeholder="e.g. Rahul Kumar"
          required
        />
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Contact Number</label>
        <input
          type="tel"
          name="contact"
          class="form-control rounded-pill"
          placeholder="9876543210"
        />
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Purpose</label>
        <input
          type="text"
          name="purpose"
          class="form-control rounded-pill"
          placeholder="e.g. Delivery, Visit"
          required
        />
      </div>

      <!-- Simple time inputs: Date + Time separate -->
      <div class="col-md-3">
        <label class="form-label fw-semibold">In Date</label>
        <input
          type="date"
          id="inDate"
          class="form-control rounded-pill"
          required
        />
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">In Time</label>
        <input
          type="time"
          id="inTime"
          class="form-control rounded-pill"
          required
        />
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Out Date</label>
        <input type="date" id="outDate" class="form-control rounded-pill" />
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Out Time</label>
        <input type="time" id="outTime" class="form-control rounded-pill" />
      </div>

      <!-- Hidden inputs that backend expects: inTime & outTime in ISO format -->
      <input type="hidden" name="inTime" id="inTimeHidden" />
      <input type="hidden" name="outTime" id="outTimeHidden" />

      <div class="col-12 d-flex justify-content-end mt-2">
        <button type="submit" class="btn btn-gradient rounded-pill px-4">
          <i class="bi bi-send-check me-1"></i>Submit Request
        </button>
      </div>
    </form>
  </div>

  <!-- Visitor Summary Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div
        class="summary-card text-center shadow-sm p-4 bg-success text-white rounded-4"
      >
        <i class="bi bi-person-check fs-2"></i>
        <h6 class="mt-2">Approved</h6>
        <h2>
          <%= (visitors || []).filter(v => v.status === 'Approved').length %>
        </h2>
      </div>
    </div>

    <div class="col-md-4">
      <div
        class="summary-card text-center shadow-sm p-4 bg-warning text-dark rounded-4"
      >
        <i class="bi bi-hourglass-split fs-2"></i>
        <h6 class="mt-2">Pending</h6>
        <h2>
          <%= (visitors || []).filter(v => v.status === 'Pending').length %>
        </h2>
      </div>
    </div>

    <div class="col-md-4">
      <div
        class="summary-card text-center shadow-sm p-4 bg-secondary text-white rounded-4"
      >
        <i class="bi bi-door-open fs-2"></i>
        <h6 class="mt-2">Checked-Out</h6>
        <h2>
          <%= (visitors || []).filter(v => v.status === 'Checked-Out').length %>
        </h2>
      </div>
    </div>
  </div>

  <!-- Visitor Log Table -->
  <% if (!visitors || visitors.length === 0) { %>
  <div class="empty-state text-center py-5 glass-card">
    <img
      src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png"
      width="130"
    />
    <h5 class="fw-semibold mt-3 text-muted">No Visitor Records Found</h5>
    <p class="text-muted small mb-0">Add visitors using the form above.</p>
  </div>
  <% } else { %>

  <div class="table-responsive glass-card shadow-lg p-4 rounded-4 mb-4">
    <h5 class="fw-bold mb-3 text-gradient">
      <i class="bi bi-list-check me-2"></i>Visitor Log
    </h5>

    <table class="table align-middle table-hover">
      <thead class="table-header">
        <tr>
          <th>Visitor</th>
          <th>Purpose</th>
          <th>In Time</th>
          <th>Out Time</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody>
        <% visitors.forEach(v => { %>
        <tr>
          <td class="fw-semibold">
            <i class="bi bi-person-circle me-1"></i><%= v.name %>
          </td>
          <td><%= v.purpose %></td>
          <td><%= v.inTime ? new Date(v.inTime).toLocaleString() : '-' %></td>
          <td><%= v.outTime ? new Date(v.outTime).toLocaleString() : '-' %></td>
          <td>
            <span
              class="badge rounded-pill px-3 py-2 <%= v.status === 'Approved' ? 'bg-success' : v.status === 'Checked-Out' ? 'bg-secondary' : 'bg-warning text-dark' %>"
            >
              <%= v.status %>
            </span>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <% } %>

  <!-- Recent History (latest 5) -->
  <div class="glass-card p-4 rounded-4 shadow-sm">
    <h5 class="fw-bold text-gradient mb-3">
      <i class="bi bi-clock-history me-2"></i>Recent Visitor History
    </h5>

    <% const history = (visitors || []).slice(0, 5); %> <% if (history.length
    === 0) { %>
    <p class="text-muted">No recent visitors.</p>
    <% } else { %>
    <ul class="list-group list-group-flush">
      <% history.forEach(h => { %>
      <li class="list-group-item bg-transparent">
        <i class="bi bi-clock me-2 text-primary"></i>
        <strong><%= h.name %></strong> â€” <%= h.purpose %>
        <span class="text-muted"
          >(<%= h.inTime ? new Date(h.inTime).toLocaleString() : '-' %>)</span
        >
      </li>
      <% }) %>
    </ul>
    <% } %>
  </div>
</section>

<!-- Styles -->
<style>
  .text-gradient {
    background: linear-gradient(90deg, #007bff, #6610f2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.94);
    backdrop-filter: blur(12px);
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.4);
  }

  .btn-gradient {
    background: linear-gradient(90deg, #007bff, #00bfff);
    color: #fff;
  }

  .table-header {
    background: linear-gradient(90deg, #007bff, #00bfff);
    color: white;
  }

  .summary-card {
    border-radius: 16px;
  }

  @media (max-width: 768px) {
    .summary-card {
      padding: 18px;
    }
  }
</style>

<!-- JS: combine date+time into ISO strings before submit -->
<script>
  document
    .getElementById("visitorForm")
    .addEventListener("submit", function (e) {
      // combine inDate + inTime into ISO string for backend
      const inDate = document.getElementById("inDate").value;
      const inTime = document.getElementById("inTime").value;
      const outDate = document.getElementById("outDate").value;
      const outTime = document.getElementById("outTime").value;

      // validate required inputs
      if (!inDate || !inTime) {
        e.preventDefault();
        alert("Please select In date and time.");
        return;
      }

      // Combine to "YYYY-MM-DDTHH:MM:SS" format (seconds optional). We'll add ":00"
      const inIso = `${inDate}T${inTime}:00`;
      document.getElementById("inTimeHidden").value = inIso;

      if (outDate && outTime) {
        const outIso = `${outDate}T${outTime}:00`;
        document.getElementById("outTimeHidden").value = outIso;
      } else {
        // clear hidden outTime so backend can accept null/undefined
        document.getElementById("outTimeHidden").value = "";
      }

      // form submits normally
    });
</script>
